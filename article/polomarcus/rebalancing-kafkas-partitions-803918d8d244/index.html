<!doctype html><html dir=ltr lang=fr data-theme><head>
<title>
Paul Leclercq 🦕
|
Rebalancing Kafka’s partitions
</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.92.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="
      A real life feedback from TabMo’s Kafka Cluster


    ">
<link rel=stylesheet href=/blog/css/main.min.fc119528793d5518ee44dd4c76c2e5fc6edac89dfb7786ca1aa3319ed0aabc94.css integrity="sha256-/BGVKHk9VRjuRN1MdsLl/G7ayJ37d4bKGqMxntCqvJQ=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/blog/css/markupHighlight.min.058b31f17db60602cc415fd63b0427e7932fbf35c70d8e341a4c39385f5f6f3e.css integrity="sha256-BYsx8X22BgLMQV/WOwQn55MvvzXHDY40Gkw5OF9fbz4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/blog/css/custom.min.7921befed176e5efe5d9a1ff6944b6f52d57d1c5835d6f3095c4574bb47b904d.css integrity="sha256-eSG+/tF25e/l2aH/aUS29S1X0cWDXW8wlcRXS7R7kE0=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/blog/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/blog/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/blog/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/blog/favicons/favicon-16x16.png>
<link rel=canonical href=https://polomarcus.github.io/blog/article/polomarcus/rebalancing-kafkas-partitions-803918d8d244/>
<script type=text/javascript src=/blog/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w=" crossorigin=anonymous></script>
<script type=text/javascript src=/blog/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Rebalancing Kafka’s partitions">
<meta name=twitter:description content="A real life feedback from TabMo’s Kafka Cluster">
<meta property="og:title" content="Rebalancing Kafka’s partitions">
<meta property="og:description" content="A real life feedback from TabMo’s Kafka Cluster">
<meta property="og:type" content="article">
<meta property="og:url" content="https://polomarcus.github.io/blog/article/polomarcus/rebalancing-kafkas-partitions-803918d8d244/"><meta property="article:section" content="article">
<meta property="article:published_time" content="2018-10-29T12:53:30+00:00">
<meta property="article:modified_time" content="2018-10-29T12:53:30+00:00"><meta property="og:site_name" content="Paul Leclercq 🦕">
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"article","name":"Rebalancing Kafka’s partitions","headline":"Rebalancing Kafka’s partitions","alternativeHeadline":"","description":"
      A real life feedback from TabMo’s Kafka Cluster


    ","inLanguage":"fr","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/polomarcus.github.io\/blog\/article\/polomarcus\/rebalancing-kafkas-partitions-803918d8d244\/"},"author":{"@type":"Person","name":"Paul Leclercq 🦕"},"creator":{"@type":"Person","name":"Paul Leclercq 🦕"},"accountablePerson":{"@type":"Person","name":"Paul Leclercq 🦕"},"copyrightHolder":{"@type":"Person","name":"Paul Leclercq 🦕"},"copyrightYear":"2018","dateCreated":"2018-10-29T12:53:30.47Z","datePublished":"2018-10-29T12:53:30.47Z","dateModified":"2018-10-29T12:53:30.47Z","publisher":{"@type":"Organization","name":"Paul Leclercq 🦕","url":"https://polomarcus.github.io/blog/","logo":{"@type":"ImageObject","url":"https:\/\/polomarcus.github.io\/blog\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/polomarcus.github.io\/blog\/article\/polomarcus\/rebalancing-kafkas-partitions-803918d8d244\/","wordCount":"1064","genre":[],"keywords":["kafka"]}</script>
</head>
<body>
<header><div class="page-top
animated fadeInDown">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<nav>
<ul class=nav__list id=navMenu>
<div class=nav__links>
<li>
<a href=/blog/ title>Home</a>
</li>
<li>
<a href=/blog/article/ title>Articles</a>
</li>
<li>
<a href=/blog/tags/ title>Categories | Tags</a>
</li>
</div>
<ul>
<li>
<a class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</li>
</ul>
</ul>
</nav>
</div>
</header>
<div class=wrapper>
<aside><div class="sidebar
animated fadeInDown">
<div class=sidebar__content>
<div class=logo-title>
<div class=title>
<img src="https://avatars.githubusercontent.com/u/4059615?v=4" alt="profile picture">
<h3 title><a href=/blog>Paul Leclercq 🦕</a></h3>
<div class=description>
<p>"Des nains sur des épaules de géants" - Bernard de Chartres<br><br>Data, climat, sports, congé paternité</p>
</div>
</div>
</div>
<ul class=social-links>
<li>
<a href=https://github.com/polomarcus/blog rel=me aria-label=Github title=Github>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://www.linkedin.com/in/paleclercq/ rel=me aria-label=Linkedin title=Linkedin>
<i class="fab fa-linkedin fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://twitter.com/polomarcus rel=me aria-label=Twitter title=Twitter>
<i class="fab fa-twitter fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://medium.com/@polomarcus rel=me aria-label=Medium title=Medium>
<i class="fab fa-medium fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
</div><footer class="footer footer--sidebar">
<div class=by_farbox>
<ul class=footer__list>
<li class=footer__item>
&copy;
Paul Leclercq 🦕
2022
</li>
</ul>
</div>
</footer>
<script type=text/javascript src=/blog/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W1N7B2KENY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W1N7B2KENY')</script>
</div>
</aside>
<main>
<div class=autopagerize_page_element>
<div class=content>
<div class="post
animated fadeInDown">
<div class=post-content>
<div class=post-title>
<h1>Rebalancing Kafka’s partitions</h1>
</div><p>After quite a time, uneven partitions and unbalanced brokers can make their way up to your dear Kafka cluster. Leaving you no choice but reassigning your partitions.</p>
<p>This is the story of our recent partitions reassignment at <a href=http://tabmo.io/>TabMo, an AdTech company,</a> to help you with yours.</p>
<p><img src=https://cdn-images-1.medium.com/max/1200/1*ef-RZJwEZ93kkLAGCFhgBg.png alt></p>
<p>Before starting, let’s quote the Kafka documentation about partition</p>
<blockquote>
<p>More partitions allow greater parallelism for consumption, but this will also result in more files across the brokers.</p>
</blockquote>
<p>An unbalanced cluster can generate unnecessary disk, CPU problems or even the need to add another broker to handle unexpected traffic 💥</p>
<h3 id=kafka-tools>Kafka tools</h3>
<p>These tools are great, <strong>it’s rare so it’s better to highlight them</strong> : <a href=http://kafka.apache.org/documentation.html#basic_ops_automigrate>well documented</a>, simple to use, and does not contain obvious bugs. We are going to focus on this one:</p>
<p>kafka-reassign-partitions<br>
This command moves topic partitions between replicas.</p>
<p>kafka-reassign-partitions has 2 flaws though, it is not aware of <strong>partitions size</strong>, and neither can provide a plan to reduce the number of <strong>partitions to migrate from brokers to brokers.</strong> By trusting it blindly, you will stress your Kafka cluster for nothing. It’s clever to calculate our own plan for large topics an to use the Kafka proposed for smaller one.</p>
<p><img src=https://cdn-images-1.medium.com/max/1200/1*Xf4zjEtiAsi2j4KTfVge_g.png alt></p>
<p>Thanks to our fancy calculations, we can get an optimized plan for Kafka 🔬</p>
<h3 id=practice-with-docker-compose>Practice with Docker-compose</h3>
<p><a href=https://github.com/simplesteph/kafka-stack-docker-compose/>This repo by</a> <a href=https://medium.com/u/98189c4cef0>Stéphane Maarek</a>, a Kafka evangelist, <a href=https://github.com/simplesteph/kafka-stack-docker-compose/>is a goldmine</a>, it contains all versions of Kafka, and a yaml file that provide <a href=https://github.com/Landoop/kafka-topics-ui>the handy Landoop’s UIs</a>.</p>
<h4 id=launch-our-kafkastack>Launch our kafka stack</h4>
<p>With this repo, we can practice our skills before executing the reassignment of our dev and prod cluster. Here, we are going to increase the replication factor of one topic. This is the same script used for partitions reassignment, so it will be the same as moving partitions from broker to broker.</p>
<p>git clone <a href=mailto:git@github.com>git@github.com</a>:simplesteph/kafka-stack-docker-compose.git</p>
<p>#Choose your own Kafka version thanks to the repo tags<br>
git checkout tags/v4.1.0 for example</p>
<p>Choose your favorite yaml file from the repo, in our case we want multiple brokers, so zk-single-kafka-multiple.yml is ideal.</p>
<p># the -d is for detached to avoid massive log spam<br>
docker-compose -f zk-single-kafka-multiple.yml up -d</p>
<h4 id=create-our-topicmy-topic>Create our topic my-topic</h4>
<p>Once your containers are ready , you can connect to one of your broker, out of 3, to generate a topics, by sending messages directly</p>
<p># get kafka container name &ndash;> kafkastackdockercompose_kafka1_1<br>
docker ps</p>
<p># Connect to our broker<br>
docker exec -it kafkastackdockercompose_kafka1_1 bash</p>
<p><strong># All Kafka&rsquo;s scripts are stored in /usr/bin so available from everywhere</strong><br>
kafka-console-producer &ndash;broker-list localhost:9092 &ndash;topic my-topic</p>
<p>> message 1<br>
> message 2</p>
<h4 id=increase-the-number-of-partition-from-1-to3>Increase the number of partition from 1 to 3</h4>
<p>Just to have more partitions to “play” with.</p>
<p>kafka-topics &ndash;topic my-topic &ndash;alter &ndash;partitions 3 &ndash;zookeeper zoo1</p>
<p># Observe partitions with Number of partition 3 and RF: 1<br>
kafka-topics &ndash;topic my-topic &ndash;describe &ndash;zookeeper zoo1</p>
<p>Topic:my-topic PartitionCount:3 ReplicationFactor:1 Configs:<br>
Topic: my-topic Partition: 0 Leader: 1 Replicas: 1 Isr: 1<br>
Topic: my-topic Partition: 1 Leader: 2 Replicas: 2 Isr: 2<br>
Topic: my-topic Partition: 2 Leader: 3 Replicas: 3 Isr: 3</p>
<h4 id=describe-the-topic-we-want-tomove>Describe the topic we want to “move”</h4>
<p><a href=http://kafka.apache.org/documentation.html#basic_ops_automigrate>Based on the documentation</a>, we can use a template to select our topic to move, but we can also generate it by using this TabMo homemade script. It will select all topics and generate our topics-to-move.json</p>
<p>echo &lsquo;{&ldquo;topics&rdquo;: [&rsquo; > topics-to-move.json && kafka-topics &ndash;zookeeper $ZK_SERVERS &ndash;list | perl -ne &lsquo;chomp;print &ldquo;{\&ldquo;topic\": \"$_\"},\n&rdquo;&rsquo; &#187; topics-to-move.json && truncate &ndash;size=-2 topics-to-move.json && echo &lsquo;],&ldquo;version&rdquo;:1}&rsquo; &#187; topics-to-move.json</p>
<p>cat topics-to-move.json<br>
{&ldquo;topics&rdquo;: [<br>
{&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;}],&ldquo;version&rdquo;:1}</p>
<h4 id=generate-a-plan-for-our-reassignment>Generate a plan for our reassignment</h4>
<p>kafka-reassign-partitions &ndash;zookeeper zoo1:2181 &ndash;broker-list &ldquo;1,2,3&rdquo; &ndash;topics-to-move-json-file topics-to-move.json &ndash;generate > full-reassignment-file.json</p>
<p>Keep the rollback json file somewhere, just in case. <strong>Heads up,</strong> you will not be able to rollback your plan until your first plan is completely done.</p>
<p>cat full-reassignment-file.json | grep version | head -n 1 > rollback.json</p>
<p>cat full-reassignment-file.json | grep version | tail -n 1 > reassignment.json</p>
<p>{<br>
&ldquo;version&rdquo;:1,<br>
&ldquo;partitions&rdquo;:[ {<br>
&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;, &ldquo;partition&rdquo;: 1, &ldquo;replicas&rdquo;: <strong>[1]</strong><br>
}<br>
,<br>
{<br>
&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;, &ldquo;partition&rdquo;: 0, &ldquo;replicas&rdquo;: <strong>[3]</strong><br>
}<br>
,<br>
{<br>
&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;, &ldquo;partition&rdquo;: 2, &ldquo;replicas&rdquo;: <strong>[2]</strong><br>
}<br>
]<br>
}</p>
<h4 id=optimize-the-proposedplan>Optimize the proposed plan</h4>
<p><strong><em>Heads up</em></strong><em>, Kafka’s kafka-reassign-partitions script is not aware of partitions size, does not limit partition migration between brokers, and does not generate a deterministic plan, so you should not trust it. Just use it as a template and calculate yourself your plan while limiting partitions migrations.</em></p>
<p>We are going to increase the replication factor (RF) to 3.</p>
<p>sed -i &rsquo;s/\[[1-3]\]/[1,2,3]/g' reassignment.json</p>
<p>cat reassignment.json<br>
{<br>
&ldquo;version&rdquo;:1,<br>
&ldquo;partitions&rdquo;:[ {<br>
&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;, &ldquo;partition&rdquo;: 1, &ldquo;replicas&rdquo;: <strong>[1,2,3]</strong><br>
}<br>
,<br>
{<br>
&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;, &ldquo;partition&rdquo;: 0, &ldquo;replicas&rdquo;: <strong>[1,2,3]</strong><br>
}<br>
,<br>
{<br>
&ldquo;topic&rdquo;: &ldquo;my-topic&rdquo;, &ldquo;partition&rdquo;: 2, &ldquo;replicas&rdquo;: <strong>[1,2,3]</strong><br>
}<br>
]<br>
}</p>
<h4 id=migrate>Migrate</h4>
<p>kafka-reassign-partitions &ndash;zookeeper zoo1 &ndash;reassignment-json-file reassignment.json <strong>--execute</strong></p>
<h4 id=monitor-andverify>Monitor and verify</h4>
<p>kafka-reassign-partitions &ndash;zookeeper zoo1 &ndash;reassignment-json-file reassignment.json <strong>--verify</strong><br>
Status of partition reassignment:<br>
Reassignment of partition [my-topic,0] completed successfully<br>
Reassignment of partition [my-topic,2] completed successfully<br>
Reassignment of partition [my-topic,1] still in progress</p>
<p>While all topics are still in progress, we could see on this the Isr, in-sync replicas, different to replicas</p>
<p>root@kafka1:/# kafka-topics &ndash;topic my-topic &ndash;describe &ndash;zookeeper zoo1<br>
Topic:my-topic PartitionCount:3 ReplicationFactor:3 Configs:<br>
Topic: my-topic Partition: 0 Leader: 1 Replicas: 1,2,3 Isr: 1,3,2<br>
Topic: my-topic Partition: 1 Leader: 2 <strong>Replicas</strong>: 1,2,3 <strong>Isr</strong>: 2,3<br>
Topic: my-topic Partition: 2 Leader: 3 Replicas: 1,2,3 Isr: 3,2,1</p>
<h3 id=be-safe-notsorry>Be safe, not sorry</h3>
<p>During partitions reassignment more resources are going to be used, be sure your cluster can handle +20% CPU usage and up to +30% disk.</p>
<p><strong>Heads up</strong>, while a partition is not entirely migrated, its origin broker will keep the entire copy of this partition. If this broker is receiving another partition, its disk usage can go through the roof!</p>
<p><img src=https://cdn-images-1.medium.com/max/800/1*wiZLmuu82AVQKqtxB_NJ6A.png alt>
<img src=https://cdn-images-1.medium.com/max/800/1*E-efxXU8PgTlBPbDeXHLdg.png alt></p>
<p><strong>Protips</strong>: It’s smarter to move large topics, topic by topic. The task will last longer, but your cluster’s disks will be safe.</p>
<h3 id=future-work-automate-thisprocess>Future work : Automate this process</h3>
<p>At TabMo we currently use Kafka’s scripts and excel sheets, we’ll definitely try these new DataDog’s tools (<strong>EDIT 2019</strong>: we do now 😁), it removes a lot of manual pain points, such as providing you the smartest migration plan limiting partitions migration between brokers and is aware of partitions size.</p>
<blockquote>
<p><code>topicmappr</code> is a drop-in replacement for the Kafka <code>kafka-reassign-partitions.sh</code> script <code>--generate</code></p>
</blockquote>
<p><a href=https://www.datadoghq.com/blog/engineering/introducing-kafka-kit-tools-for-scaling-kafka/ title=https://www.datadoghq.com/blog/engineering/introducing-kafka-kit-tools-for-scaling-kafka/><strong>Introducing Kafka-Kit: Tools for Scaling Kafka</strong><br>
_For a company with data in the name, it&rsquo;s no surprise that we ingest large amounts of it. Kafka is our messaging…_www.datadoghq.com</a><a href=https://www.datadoghq.com/blog/engineering/introducing-kafka-kit-tools-for-scaling-kafka/></a></p>
<p><a href=https://github.com/DataDog/kafka-kit/tree/master/cmd/topicmappr title=https://github.com/DataDog/kafka-kit/tree/master/cmd/topicmappr><strong>DataDog/kafka-kit</strong><br>
_Kafka data mapping and recovery tools. Contribute to DataDog/kafka-kit development by creating an account on GitHub._github.com</a><a href=https://github.com/DataDog/kafka-kit/tree/master/cmd/topicmappr></a></p>
</div>
<div class=post-footer>
<div class=info>
<span class=separator><a class=tag href=/blog/tags/kafka/>kafka</a></span>
</div>
</div>
</div>
</div>
</div>
</main>
</div><footer class="footer footer--base">
<div class=by_farbox>
<ul class=footer__list>
<li class=footer__item>
&copy;
Paul Leclercq 🦕
2022
</li>
</ul>
</div>
</footer>
<script type=text/javascript src=/blog/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W1N7B2KENY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W1N7B2KENY')</script>
</body>
</html>