<!doctype html><html dir=ltr lang=en data-theme=dark><head>
<title>
Paul Leclercq 🦕
|
Graceful shutdown using Simple Sytems Manager and Terraform on AWS
</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.88.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="
      Automate all the things


    ">
<link rel=stylesheet href=/blog/css/main.min.c8134cb774dfba55fccabcdd38720226c744ed4e75a45d66fdb161ba847d0761.css integrity="sha256-yBNMt3TfulX8yrzdOHICJsdE7U51pF1m/bFhuoR9B2E=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/blog/css/markupHighlight.min.8e4c8f0a940b1596fb4c64d28a00a5ceed671fc303cb65178b4947417da9c674.css integrity="sha256-jkyPCpQLFZb7TGTSigClzu1nH8MDy2UXi0lHQX2pxnQ=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/blog/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/blog/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/blog/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/blog/favicons/favicon-16x16.png>
<link rel=canonical href=/blog/article/2020-01-13_graceful-shutdown-using-simple-sytems-manager-and-terraform-on-aws-f11deb6a4e24/>
<script type=text/javascript src=/blog/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w=" crossorigin=anonymous></script>
<script type=text/javascript src=/blog/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Graceful shutdown using Simple Sytems Manager and Terraform on AWS">
<meta name=twitter:description content="Automate all the things">
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"article","name":"Graceful shutdown using Simple Sytems Manager and Terraform on AWS","headline":"Graceful shutdown using Simple Sytems Manager and Terraform on AWS","alternativeHeadline":"","description":"
      Automate all the things


    ","inLanguage":"fr-fr","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/polomarcus.github.com\/blog\/article\/2020-01-13_graceful-shutdown-using-simple-sytems-manager-and-terraform-on-aws-f11deb6a4e24\/"},"author":{"@type":"Person","name":"Paul Leclercq 🦕"},"creator":{"@type":"Person","name":"Paul Leclercq 🦕"},"accountablePerson":{"@type":"Person","name":"Paul Leclercq 🦕"},"copyrightHolder":{"@type":"Person","name":"Paul Leclercq 🦕"},"copyrightYear":"2020","dateCreated":"2020-01-13T10:00:27.52Z","datePublished":"2020-01-13T10:00:27.52Z","dateModified":"2020-01-13T10:00:27.52Z","publisher":{"@type":"Organization","name":"Paul Leclercq 🦕","url":"http://polomarcus.github.com/blog/","logo":{"@type":"ImageObject","url":"http:\/\/polomarcus.github.com\/blog\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"http:\/\/polomarcus.github.com\/blog\/article\/2020-01-13_graceful-shutdown-using-simple-sytems-manager-and-terraform-on-aws-f11deb6a4e24\/","wordCount":"654","genre":[],"keywords":[]}</script>
</head>
<body>
<header><div class="page-top
animated fadeInDown">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<nav>
<ul class=nav__list id=navMenu>
<div class=nav__links>
<li>
<a href=/blog/ title>Home</a>
</li>
<li>
<a href=/blog/article/ title>Articles</a>
</li>
<li>
<a href=/blog/tags/ title>Categories | Tags</a>
</li>
</div>
<li>
<a class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</li>
</ul>
</nav>
</div>
</header>
<div class=wrapper>
<aside><div class="sidebar
animated fadeInDown">
<div class=sidebar__content>
<div class=logo-title>
<div class=title>
<img src="https://avatars.githubusercontent.com/u/4059615?v=4" alt="profile picture">
<h3 title><a href=/blog>Paul Leclercq 🦕</a></h3>
<div class=description>
<p>"Des nains sur des épaules de géants" - Bernard de Chartres<br><br>Data, climat, sports, congé paternité<br></p>
</div>
</div>
</div>
<ul class=social-links>
<li>
<a href=https://www.github.com/polomarcus rel=me aria-label=Github>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://www.linkedin.com/in/paleclercq/ rel=me aria-label=Linkedin>
<i class="fab fa-linkedin fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://twitter.com/polomarcus rel=me aria-label=Twitter>
<i class="fab fa-twitter fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://medium.com/@polomarcus rel=me aria-label=Medium>
<i class="fab fa-medium fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
</div><footer class="footer footer--sidebar">
<div class=by_farbox>
<ul class=footer__list>
<li class=footer__item>
&copy;
Paul Leclercq 🦕
2021
</li>
</ul>
</div>
</footer>
<script type=text/javascript src=/blog/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W1N7B2KENY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W1N7B2KENY')</script>
</div>
</aside>
<main>
<div class=autopagerize_page_element>
<div class=content>
<div class="post
animated fadeInDown">
<div class=post-content>
<div class=post-title>
<h1>Graceful shutdown using Simple Sytems Manager and Terraform on AWS</h1>
</div><h3 id=automate-all-thethings>Automate all the things</h3>
<p>At <a href=https://labs.tabmo.io/>TabMo</a>, we slowly but surely move our services from Jenkins to GitlabCI and automate all the things that can be thanks to <a href=https://martinfowler.com/bliki/BlueGreenDeployment.html>blue/green deployments</a> with Terraform or <a href=https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#what-is-a-service>docker images for integration tests</a>. Our goal is to reduce human checks, or SSH connections as much as possible.</p>
<p>We encounter a problem for slow-terminating app such as reporting app, <em>slow means on AWS 1min30</em> 😅. These apps can be killed too quickly for them to safely process their data. It forced us to SSH to our instances to stop them via a <code>systemctl stop service</code> when we had to deploy new code or if we wanted to reduce our number of instances in ASGs. It also means no automated ASG scale-in when our traffic peak are over, and force us to pay for some servers that we do not need anymore 💸</p>
<p><img src=https://cdn-images-1.medium.com/max/800/1*9WUAFw0gYHTiijr6TsFlTA.png alt></p>
<p><a href=https://circleci.com/blog/graceful-shutdown-using-aws/>CircleCI has done a great job explaining how to set up Auto Scaling Groups (ASG), Auto Scaling Lifecycle Hooks, and SQS Queues to manage how to gracefully shutdown slow terminating apps.</a> This blog article focus on what to do after our SQS queue has received a lifecycle hooks message from an ASG.</p>
<h3 id=using-a-lambda-and-systemsmanager>Using a Lambda and Systems Manager</h3>
<p>To send a bash command to remote servers we chose to use <a href=https://aws.amazon.com/systems-manager/>AWS Systems Manager</a> and <a href=https://docs.aws.amazon.com/lambda/latest/dg/with-sqs-create-package.html#with-sqs-example-deployment-pkg-python>AWS Lambda</a>. This lambda is triggered when a Lifecycle hook message is received by a SQS queue. These messages come from our Auto Scaling Group when a instance is on its way to be terminated.</p>
<p><img src=https://cdn-images-1.medium.com/max/800/1*Hz4oNUUhRZO6Smnp8xHlcQ.jpeg alt></p>
<h4 id=lambda>Lambda</h4>
<p>Step one is to parse SQS messages. We check if this is a terminating event from our service, then delete the message from the SQS queue, to avoid infinite loop in case something goes wrong. Finally our lambda sends a bash command to the targeted instances, <em>the instance ID to terminate is inside the Lifecycle hook message</em>, via System Manager installed by default on our ASG instances.</p>
<p>To perform System Manager commands on our instances, <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/auth-and-access-control-iam-identity-based-access-control.html#managed-policies>we have to give the right permissions</a> to our app:</p>
<pre tabindex=0><code>resource &quot;aws\_iam\_role\_policy\_attachment&quot; &quot;app\_ssm\_attach&quot; _{_  role       = &quot;_${_aws\_iam\_role.app.name_}_&quot;  
  policy\_arn = &quot;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&quot;  
}
</code></pre><p>And the right permissions for our Lambda:</p>
<pre tabindex=0><code>resource &quot;aws\_iam\_policy&quot; &quot;lambda-ssm-asg&quot; _{_  name        = &quot;lambda-ssm-asg-_env_&quot;  
  policy = &lt;&lt;EOF  
{  
  &quot;Version&quot;: &quot;2012-10-17&quot;,  
  &quot;Statement&quot;: \[  
    {  
        &quot;Effect&quot;: &quot;Allow&quot;,  
        &quot;Action&quot;: \[  
          &quot;ssm:SendCommand&quot;  
        \],  
        &quot;Resource&quot;: \[  
          &quot;arn:aws:ssm:\*::document/AWS-RunShellScript&quot;,  
          &quot;arn:aws:ec2:\*:account:instance/\*&quot;  
        \]  
    }  
  \]  
}  
EOF  
_}_
</code></pre><p>After these permissions set, we can use this python function to send bash command to our ASG’s instances</p>
<h4 id=trust-butverify>Trust, but verify</h4>
<p>To check that our Lambda does what it supposes to do, we can check on the EC2 console that our previous instance (in orange) has completed its last job before shutting down or check on our logging system for a graceful shutdown log 🐕</p>
<p><img src=https://cdn-images-1.medium.com/max/800/1*3rlBJIOMDjc5TYYZI6lyAQ.png alt></p>
<h3 id=scaling-policy>Scaling policy</h3>
<p>To complete this new architecture, we can set a scaling policy based on a CloudWatch low cpu alert to only use what we need in term of infrastructure and save money on our AWS bills.</p>
<pre tabindex=0><code>resource &quot;aws\_autoscaling\_policy&quot; &quot;app-scale-in&quot; _{_  name                   = &quot;app-scale-in&quot;  
  scaling\_adjustment     = -1  
  adjustment\_type        = &quot;ChangeInCapacity&quot;  
  cooldown               = 900 # 30 minutes  
  autoscaling\_group\_name = &quot;_${_aws\_autoscaling\_group.app.name_}_&quot;  
_}_

resource &quot;aws\_cloudwatch\_metric\_alarm&quot; &quot;app-low-cpu&quot; {  
  alarm\_name                = &quot;app-low-cpu-alert&quot;  
  comparison\_operator       = &quot;LessThanThreshold&quot;  
  evaluation\_periods        = &quot;6&quot; # 30min  
  metric\_name               = &quot;CPUUtilization&quot;  
  namespace                 = &quot;AWS/EC2&quot;  
  period                    = &quot;300&quot; # 5 minutes  
  statistic                 = &quot;Average&quot;  
  threshold                 = &quot;40&quot;

  dimensions = _{_    AutoScalingGroupName = &quot;_${_aws\_autoscaling\_group.app.name_}_&quot;  
  _}_

  alarm\_description         = &quot;Low CPU alert&quot;  
  alarm\_actions             = _\[_&quot;_${_aws\_autoscaling\_policy.app-scale-in.arn_}_&quot;_\]  
_}
</code></pre><p>This scale in policy will gracefully shutdown instances every 30 minutes, <em>our cooldown period</em>, when all instances’ CPU inside the ASG is below 40% for 30 minutes 📉</p>
<p><img src=https://cdn-images-1.medium.com/max/800/1*m6p5EBZqQlXZGGYBRgJh1A.png alt></p>
<p>And voilà, we fully automated our deployment for our slow terminating apps, we can now save time and money 😄</p>
<h4 id=special-thanks>Special thanks</h4>
<p><a href=https://medium.com/u/2e3b8b941b1a>Ian Davis</a> for your article <a href=https://circleci.com/blog/graceful-shutdown-using-aws/>about graceful shutdowns</a></p>
<p><a href=https://medium.com/u/1f3895ec33e>Tom Elliff</a> for <a href=https://stackoverflow.com/a/58525079/3535853>your answer on Stackoverflow</a></p>
<p><a href=https://medium.com/u/8d7bdf15f710>Chloe Pellen</a> for showing me that I could draw 😁</p>
<p>And of course, <a href=https://labs.tabmo.io/>TabMo</a>’s <a href=https://medium.com/u/66a951eadd5f>Yann Blancard</a>, <a href=https://medium.com/u/e7b93f173b2b>Joakim Ribier</a>, <a href=https://medium.com/u/d473c7336a1a>Dương Khánh Chương</a>, and <a href=https://medium.com/u/63af75b950c7>Julien Lafont</a> ✊</p>
</div>
<div class=post-footer>
<div class=info>
</div>
</div>
</div>
</div>
</div>
</main>
</div><footer class="footer footer--base">
<div class=by_farbox>
<ul class=footer__list>
<li class=footer__item>
&copy;
Paul Leclercq 🦕
2021
</li>
</ul>
</div>
</footer>
<script type=text/javascript src=/blog/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W1N7B2KENY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W1N7B2KENY')</script>
</body>
</html>